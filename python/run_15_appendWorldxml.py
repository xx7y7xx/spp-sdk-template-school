# coding=utf-8import os,sysfrom xml.dom.minidom import parsefrom xml.dom.minidom import parseStringimport shutilimport configimport commonimport bucfg#--------------------------------------------------------------		# 向 world 文件中写入角色、天空、环境光、太阳光等节点# 角色和音乐节点添加到 world.xml 中def process():		print '-------------------------------'	print common.encodeChinese('>> 修改 world 结构 (run_15_appendWorldxml.py)')	print ''		worldFilePath = "%s\\target\\art\\world.xml"%(config.PROJECT_HOME)	factorylibPath = "%s\\target\\art\\factorylib.xml"%(config.PROJECT_HOME)	shaderlibPath = "%s\\target\\art\\shaderlib.xml"%(config.PROJECT_HOME)	musiclibPath = "%s\\target\\art\\soundlib.xml"%(config.PROJECT_HOME)	genCublibPath = "%s\\target\\art\\factories\\genCubelib.xml"%(config.PROJECT_HOME)		#添加人物、星星、天空的library	appendLibrary(factorylibPath)		#添加shader	appendShader(shaderlibPath)		#添加音乐	appendMusic(musiclibPath)			#添加Meshfact	apendMeshfact(genCublibPath)				if os.path.isfile(worldFilePath):				content = common.readFile(worldFilePath)		root = '<world>'		library='</library>'		if content.find(root) > -1:							# 添加 sector 中的内容			if content.find("<meshobj name=\"mesh_camera\">") <0:				# nodeString =appendSunlight()				nodeString = '\n\t\t<meshobj name="mesh_camera">'				nodeString += '\n\t\t\t<plugin>crystalspace.mesh.loader.genmesh</plugin>'				nodeString += '\n\t\t\t<params>'				nodeString += '\n\t\t\t\t<factory>genCube</factory>'				nodeString += '\n\t\t\t</params>'				# nodeString += '\n\t\t\t<zuse/>'				nodeString += '\n\t\t\t<move>'				nodeString += '\n\t\t\t\t<v x="125.6136398318164" y="-0.00004374980926513672" z="-321.6300354003906"/>'								nodeString += '\n\t\t\t</move>'				nodeString += '\n\t\t</meshobj>'				nodeString += '\n\t\t'				nodeString += '\n\t\t<meshobj name="man">'				nodeString += '\n\t\t\t<priority>portal</priority>'				nodeString += '\n\t\t\t<plugin>crystalspace.mesh.loader.sprite.cal3d</plugin>'				nodeString += '\n\t\t\t<params>'				nodeString += '\n\t\t\t\t<factory>man</factory>'				nodeString += '\n\t\t\t</params>'				nodeString += '\n\t\t\t<zuse/>'				nodeString += '\n\t\t\t<move>'				nodeString += '\n\t\t\t\t<v x="124.90711212158203" y="-10000" z="-319.63427734375"/>'				nodeString += '\n\t\t\t</move>'				nodeString += '\n\t\t</meshobj>'				nodeString += '\n\t\t'				nodeString += '\n\t\t<meshobj name="woman">'				nodeString += '\n\t\t\t<priority>portal</priority>'				nodeString += '\n\t\t\t<plugin>crystalspace.mesh.loader.sprite.cal3d</plugin>'				nodeString += '\n\t\t\t<params>'				nodeString += '\n\t\t\t\t<factory>woman</factory>'				nodeString += '\n\t\t\t</params>'				nodeString += '\n\t\t\t<zuse/>'				nodeString += '\n\t\t\t<move>'				nodeString += '\n\t\t\t\t<v x="124.90711212158203" y="-10000" z="-319.63427734375"/>'				nodeString += '\n\t\t\t</move>'				nodeString += '\n\t\t</meshobj>'				nodeString += '\n\t\t'				nodeString += '\n\t\t<meshobj name="music_bg">'				nodeString += '\n\t\t\t<plugin>crystalspace.mesh.loader.genmesh</plugin>'				nodeString += '\n\t\t\t<params>'				nodeString += '\n\t\t\t\t<factory>genCube</factory>'				nodeString += '\n\t\t\t</params>'				# nodeString += '\n\t\t\t<zuse/>'				nodeString += '\n\t\t\t<move>'				nodeString += '\n\t\t\t\t<v x="0" y="-10000" z="0"/>'				nodeString += '\n\t\t\t</move>'				nodeString += '\n\t\t</meshobj>'				nodeString += '\n\t\t'				nodeString += '\n\t\t<meshobj name="star_mesh_Plane01_10.xml">'				nodeString += '\n\t\t\t<plugin>crystalspace.mesh.loader.genmesh</plugin>'				nodeString += '\n\t\t\t<params>'				nodeString += '\n\t\t\t\t<factory>star_mesh_Plane01_10</factory>'				nodeString += '\n\t\t\t</params>'				nodeString += '\n\t\t\t<zuse/>'				nodeString += '\n\t\t\t<move>'				nodeString += '\n\t\t\t\t<v x="0" y="-10000" z="0"/>'				nodeString += '\n\t\t\t</move>'				nodeString += '\n\t\t\t<trimesh>'				nodeString += '\n\t\t\t\t<id>colldet</id>'				nodeString += '\n\t\t\t</trimesh>'				nodeString += '\n\t\t</meshobj>'				nodeString += '\n\t\t'				nodeString += '\n\t\t<meshobj name="star">'				nodeString += '\n\t\t\t<plugin>crystalspace.mesh.loader.genmesh</plugin>'				nodeString += '\n\t\t\t<params>'				nodeString += '\n\t\t\t\t<factory>star_mesh_Plane02_31</factory>'				nodeString += '\n\t\t\t</params>'				nodeString += '\n\t\t\t<zuse/>'				nodeString += '\n\t\t\t<move>'				nodeString += '\n\t\t\t\t<v x="0" y="-10000" z="0"/>'				nodeString += '\n\t\t\t</move>'				nodeString += '\n\t\t\t<trimesh>'				nodeString += '\n\t\t\t\t<id>colldet</id>'				nodeString += '\n\t\t\t</trimesh>'				nodeString += '\n\t\t</meshobj>'				nodeString += '\n\t\t'				nodeString += '\n\t\t<meshobj name="spp_bird1">'				nodeString += '\n\t\t\t<plugin>crystalspace.mesh.loader.sprite.3d</plugin>'				nodeString += '\n\t\t\t<params>'				nodeString += '\n\t\t\t\t<factory>spp_bird1</factory>'				nodeString += '\n\t\t\t\t<lighting>yes</lighting>'				nodeString += '\n\t\t\t\t<action>uvanim</action>' 				nodeString += '\n\t\t\t</params>'				nodeString += '\n\t\t\t<move>'				nodeString += '\n\t\t\t\t<v x="0" y="100" z="-300" />'				nodeString += '\n\t\t\t</move>'				nodeString += '\n\t\t</meshobj>'				nodeString += '\n\t\t'								### 若 有360全景功能 请将这里打开 update by houdongqinag				# if  os.path.exists(bucfg.panorama360Dir):					# import run_19_360scene					# nodeString += run_19_360scene.addMeshSky()				oldstr = '<meshobj'				newstr = nodeString +'\n\t' +oldstr				content = content.replace(oldstr, newstr, 1)						# 添加 <sequences> 中的内容			# 目前只有鸟的飞行			if content.find("</world>") != -1:				nodeString = '\t<sequences>'				nodeString += '\n\t\t<sequence name="spp_bird1">'				nodeString += '\n\t\t\t<move mesh="spp_bird1" duration="1000000" x="0" y="0" z="5000" />'				nodeString += '\n\t\t</sequence>'				nodeString += '\n\t</sequences>'				oldstr = "</world>"				newstr = nodeString + "\n" + oldstr				content = content.replace(oldstr, newstr, 1)						# 将新的 world 文件重新写入			f =  open( worldFilePath ,  'w')			f.write(content)			f.close()			# 创建meshobj 节点之前，先删除已经存在的			# delExistNode("clouds", worldDoc, sector, "meshobj")			# 添加天空和云			# sector.appendChild(				# createMeshobj(worldDoc,"cloud","clouds", "genclouds", 				# '141.6434326171875','410.20166015625','-24.79443359375')			# )						# sector.appendChild( worldDoc.createTextNode('\n\t'))			# sector.appendChild(				# createMeshobj(worldDoc, "sky", "sky_mesh_sky_01_10.xml", "sky_mesh_sky_01_10", 				# '141.6434326171875','410.20166015625','-24.79443359375')			# )			# sector.appendChild( worldDoc.createTextNode('\n\t'))					# sector.appendChild(				# createMeshobj(worldDoc, "sky", "sky_mesh_sky_02_31.xml", "sky_mesh_sky_02_31", 				# '141.6434326171875','-410.20166015625','-24.79443359375')			# )			else:		print common.encodeChinese(config.ERR705)		os._exit(0)			print ''			#添加library# 人物 : woman, man# 天空 : sky# 星星 : star# 飞鸟 : birddef appendLibrary(factorylibPath):	if os.path.isfile(factorylibPath):		content = common.readFile(factorylibPath)		root = '<library>'		newContent=""		if content.find(root) > -1:			# newContent=""			if content.find("models")< 0:				newContent = '\n  <library>/art/models/world_woman.xml</library>'				newContent += '\n  <library>/art/models/world_man.xml</library>'				newContent += '\n  <library>/art/models/world_star.xml</library>'				newContent += '\n  <library>/art/models/world_sky.xml</library>'				newContent += '\n  <library>/art/models/world_bird.xml</library>'				newContent += '\n  <library>/art/factories/genCubelib.xml</library>'				newContent += '\n  <library>/art/soundlib.xml</library>'								### 若 有360全景功能 请将这里打开 update by houdongqinag				### 添加box的到factory				# if  os.path.exists(bucfg.panorama360Dir):					# import run_19_360scene					# newContent += run_19_360scene.addBoxFacLib()				content=content.replace(root,root+newContent,1)	# 将新的 world 文件重新写入	f =  open(factorylibPath,'w')	f.write(content)	f.close()			#添加shader	def appendShader(shaderlibPath):	if os.path.isfile(shaderlibPath):		content = common.readFile(shaderlibPath)		root = '</shaders>'		newContent=""		if content.find(root) > -1:			# newContent=content.split('</shaders>')[0]			if content.find("clouds2")< 0:				print "......................"				newContent += '\t<shader>'				newContent += '\n\t <file>/shader/sky/clouds2.xml</file>'				newContent += '\n\t</shader>'								### 添加全景预览的box的shader				import run_19_360scene				newContent += run_19_360scene.addBoxShaLib()								newContent += '\n'				content=content.replace(root,newContent+root)		# 将新的 world 文件重新写入		f =  open(shaderlibPath ,  'w')		f.write(content)		f.close()			#添加和拷贝音乐def appendMusic(musiclibPath):		nodeString="<library>"	nodeString +=    '\n\t<sounds>'	nodeString += '\n\t\t<sound name="background">'	nodeString += '\n\t\t\t<file>/art/music/background.ogg</file>'	nodeString += '\n\t\t</sound>'	nodeString += '\n\t</sounds>'	nodeString += '</library>'	# 将新的 music 文件重新写入	f =  open(musiclibPath ,  'w')	f.write(nodeString)	f.close()		# 拷贝音乐文件	musicDir = bucfg.targetDir+"art\\music\\"	if not os.path.isdir(musicDir):		os.mkdir(musicDir)			shutil.copyfile(bucfg.wavMusicFile,  musicDir + bucfg.musicFileName)		#添加太阳光和环境光def  appendSunlight():	#读取阳光的xml		#position	x=""	y=""	z=""	#sun	r=""	g=""	b=""	#amb	r_a=""	g_a=""	b_a=""		#读取阳光位置xml	lightDoc = parse( bucfg.prdLightXml )	sunDoc = parse( bucfg.sunPosXml )	sunpos = sunDoc.getElementsByTagName("sunpos")	sun = lightDoc.getElementsByTagName("sun")	# ambient = lightDoc.getElementsByTagName("ambient")	if len(sunpos)>0:		for node in sunpos[0].childNodes:			if node.nodeName=="xpos":				x = node.firstChild.nodeValue			if node.nodeName=="ypos":				y = node.firstChild.nodeValue			if node.nodeName=="zpos":				z= node.firstChild.nodeValue					if len(sun)>0:		for node in sun[0].childNodes:			if node.nodeName=="r":				r = node.firstChild.nodeValue			if node.nodeName=="g":				g = node.firstChild.nodeValue			if node.nodeName=="b":				b = node.firstChild.nodeValue	# if len(ambient)>0:		# for node in ambient[0].childNodes:			# if node.nodeName=="r":				# r_a = node.firstChild.nodeValue			# if node.nodeName=="g":				# g_a = node.firstChild.nodeValue			# if node.nodeName=="b":				# b_a = node.firstChild.nodeValue										print r_a	# except:		# print common.encodeChinese("product/init/light.xml 文件中找不到所需的信息")	sunString=""	sunString +="\n\t<light name=\"sun\">"	sunString +="\n\t\t\t<center x=\""+x+"\" y=\""+y+"\" z=\""+z+"\"/>"	sunString +="\n\t\t\t<color blue=\""+b+"\" green=\""+g+"\" red=\""+r+"\"/>"	sunString +="\n\t\t\t<radius>1000000</radius>"	sunString +="\n\t\t</light>"	# sunString +="\n\t\t<ambient blue=\""+b_a+"\" green=\""+g_a+"\" red=\""+r_a+"\"></ambient>"	sunString +="\n"	return sunString	#添加genCubedef apendMeshfact(dir):	nodeString = '<library>'	nodeString += '\n\t<meshfact name="genCube">'	nodeString += '\n\t\t<plugin>crystalspace.mesh.loader.factory.genmesh</plugin>'	# nodeString += '\n\t\t<zuse/>'	nodeString += '\n\t\t<params>'	nodeString += '\n\t\t\t<material>t_690_tm</material>'	nodeString += '\n\t\t\t<v nx="0.000000" ny="-1.000000" nz="0.000000" x="0.001" y="-0.001" z="0.001"/>'	nodeString += '\n\t\t\t<v nx="0.000000" ny="-1.000000" nz="0.000000" x="0.001" y="-0.001" z="-0.001"/>'	nodeString += '\n\t\t\t<v nx="0.000000" ny="-1.000000" nz="0.000000" x="-0.001" y="-0.001" z="-0.001"/>'	nodeString += '\n\t\t\t<v nx="0.000000" ny="-1.000000" nz="0.000000" x="-0.001" y="-0.001" z="0.001"/>'	nodeString += '\n\t\t\t<t v1="2" v2="1" v3="0"/>'	nodeString += '\n\t\t</params>'	nodeString += '\n\t</meshfact>'	nodeString += '\n</library>'		common.writeNewFile(dir,nodeString)	